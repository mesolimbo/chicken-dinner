class Q{canvas;ctx;currentScene=null;lastTime=0;accumulator=0;constructor(E){let M=document.getElementById(E);if(!M)throw Error(`Canvas element with id "${E}" not found`);this.canvas=M;let F=M.getContext("2d");if(!F)throw Error("Could not get 2D context");this.ctx=F}async setScene(E){this.currentScene=E,await E.create(this.ctx)}start(){this.lastTime=performance.now(),this.loop(this.lastTime)}loop=(E)=>{let M=E-this.lastTime;this.lastTime=E,this.accumulator+=M;while(this.accumulator>=33.333333333333336){if(this.currentScene)this.currentScene.update(this.ctx,33.333333333333336);this.accumulator-=33.333333333333336}requestAnimationFrame(this.loop)};getCanvas(){return this.canvas}getContext(){return this.ctx}}class Z{grassImg=null;bushesImg=null;foxImg=null;dogImg=null;chickImg=null;chickBonesImg=null;titleImg=null;cluckSound=null;barkSound=null;introSound=null;lastBarkTime=0;scale=1;offsetX=0;offsetY=0;mapCanvas=null;mapCtx=null;wallMatrix=[];intersectionTiles=new Set;cameraX=0;cameraY=0;keys=new Set;player={x:0,y:0,width:0,height:0,frame:0};npcs=[];gameStarted=!1;gameOver=!1;levelComplete=!1;canvas=null;mouseTarget=null;isMouseDown=!1;score=0;highScore=0;level=1;lastAnimTime=0;async create(E){this.canvas=E.canvas,this.loadHighScore(),this.updateCanvasSize(),window.addEventListener("resize",()=>this.updateCanvasSize()),await this.loadAssets(),this.generateMaze(),this.initPlayer(),this.initNPCs(),this.renderMapToBuffer(),this.setupInput()}updateCanvasSize(){if(!this.canvas)return;this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight;let E=this.canvas.width/426,M=this.canvas.height/720;this.scale=Math.min(E,M),this.offsetX=(this.canvas.width-426*this.scale)/2,this.offsetY=(this.canvas.height-720*this.scale)/2}loadHighScore(){let E=document.cookie.match(/foxHighScore=(\d+)/);if(E)this.highScore=parseInt(E[1],10)}saveHighScore(){let E=new Date;E.setFullYear(E.getFullYear()+1),document.cookie=`foxHighScore=${this.highScore};expires=${E.toUTCString()};path=/`}setupInput(){document.addEventListener("touchend",(M)=>{if(!this.gameStarted)this.startGame(),M.preventDefault()},{once:!0}),window.addEventListener("keydown",(M)=>{if(this.keys.add(M.key),M.key===" "){if(!this.gameStarted)this.startGame();else if(this.gameOver)this.restartGame();else if(this.levelComplete)this.nextLevel()}}),window.addEventListener("keyup",(M)=>{this.keys.delete(M.key)});let E=(M,F)=>{if(!this.canvas)return null;let S=this.canvas.getBoundingClientRect(),A=(M-S.left)*(this.canvas.width/S.width),_=(F-S.top)*(this.canvas.height/S.height),f=(A-this.offsetX)/this.scale,D=(_-this.offsetY)/this.scale;return{x:f+this.cameraX,y:D+this.cameraY}};this.canvas?.addEventListener("mousedown",(M)=>{if(!this.gameStarted){this.startGame();return}if(this.gameOver){this.restartGame();return}if(this.levelComplete){this.nextLevel();return}this.isMouseDown=!0,this.mouseTarget=E(M.clientX,M.clientY)}),this.canvas?.addEventListener("mousemove",(M)=>{if(this.isMouseDown&&!this.gameOver)this.mouseTarget=E(M.clientX,M.clientY)}),window.addEventListener("mouseup",()=>{this.isMouseDown=!1}),this.canvas?.addEventListener("touchstart",(M)=>{if(M.preventDefault(),!this.gameStarted||this.gameOver||this.levelComplete)return;let F=M.touches[0];this.isMouseDown=!0,this.mouseTarget=E(F.clientX,F.clientY)}),this.canvas?.addEventListener("touchend",(M)=>{if(M.preventDefault(),!this.gameStarted){this.startGame();return}if(this.gameOver){this.restartGame();return}if(this.levelComplete){this.nextLevel();return}}),this.canvas?.addEventListener("touchmove",(M)=>{if(this.isMouseDown&&!this.gameOver){M.preventDefault();let F=M.touches[0];this.mouseTarget=E(F.clientX,F.clientY)}}),window.addEventListener("touchend",()=>{this.isMouseDown=!1})}startGame(){if(this.gameStarted=!0,this.introSound)this.introSound.currentTime=0,this.introSound.play().catch(()=>{})}restartGame(){if(this.gameOver=!1,this.levelComplete=!1,this.score=0,this.level=1,this.npcs=[],this.generateMaze(),this.initPlayer(),this.initNPCs(),this.renderMapToBuffer(),this.introSound)this.introSound.pause(),this.introSound.currentTime=0}nextLevel(){this.levelComplete=!1,this.level++,this.npcs=[],this.generateMaze(),this.initPlayer(),this.initNPCs(),this.renderMapToBuffer()}getSpeedMultiplier(){return Math.pow(1.1,this.level-1)}async loadImage(E){let F=await(await fetch(E)).blob();return createImageBitmap(F,{premultiplyAlpha:"premultiply"})}async loadAssets(){[this.grassImg,this.bushesImg,this.foxImg,this.dogImg,this.chickImg,this.chickBonesImg,this.titleImg]=await Promise.all([this.loadImage("assets/plain_grass.png"),this.loadImage("assets/bushes.png"),this.loadImage("assets/fox-sprite.png"),this.loadImage("assets/dog-sprite.png"),this.loadImage("assets/chick-sprite.png"),this.loadImage("assets/chick-bones.png"),this.loadImage("assets/title.png")]),this.cluckSound=new Audio("assets/cluck.mp3"),this.cluckSound.preload="auto",this.cluckSound.load(),this.barkSound=new Audio("assets/bark.mp3"),this.barkSound.preload="auto",this.barkSound.load(),this.introSound=new Audio("assets/intro.mp3"),this.introSound.preload="auto",this.introSound.loop=!1,this.introSound.load()}playerOnLeft=!0;initPlayer(){if(!this.foxImg)return;this.player.width=120,this.player.height=120,this.player.frame=Math.floor(Math.random()*2),this.lastAnimTime=performance.now(),this.playerOnLeft=Math.random()<0.5;let E=Math.floor(3.6666666666666665),M,F;if(this.playerOnLeft)M=0,F=E;else M=11-E-1,F=10;for(let S=0;S<50;S++){let A=M+Math.floor(Math.random()*(F-M+1)),_=Math.floor(Math.random()*6);if(this.wallMatrix[_]?.[A])continue;this.player.x=A*120,this.player.y=_*120;return}this.player.x=0,this.player.y=0}initNPCs(){if(this.dogImg){let E=Math.floor(3.6666666666666665),M,F;if(this.playerOnLeft)M=11-E-1,F=10;else M=0,F=E;this.spawnNPC(this.dogImg,"dog",M,F)}if(this.chickImg){let E=4+Math.floor(Math.random()*2);for(let M=0;M<E;M++)this.spawnNPC(this.chickImg,"chick")}}spawnNPC(E,M,F=0,S=10){for(let A=0;A<50;A++){let _=F+Math.floor(Math.random()*(S-F+1)),f=Math.floor(Math.random()*6);if(f<0||f>=6||_<0||_>=11)continue;if(this.wallMatrix[f][_])continue;let D=_*120,q=f*120;if(this.hitboxesOverlap(D,q,this.player.x,this.player.y))continue;let G=!1;for(let B of this.npcs)if(this.hitboxesOverlap(D,q,B.x,B.y)){G=!0;break}if(G)continue;this.npcs.push({x:D,y:q,width:120,height:120,img:E,type:M,dead:!1,wanderTarget:{x:D,y:q},nextWanderTime:0,stuckTime:0,prevX:D,prevY:q,frame:Math.floor(Math.random()*2),lastAnimTime:performance.now()});break}}hitboxesOverlap(E,M,F,S){let A=E+20,_=M+20,f=F+20,D=S+20;return A<f+80&&A+80>f&&_<D+80&&_+80>D}rectsOverlap(E,M,F,S,A,_,f,D){return E<A+f&&E+F>A&&M<_+D&&M+S>_}generateMaze(){this.wallMatrix=[];for(let F=0;F<6;F++)this.wallMatrix.push(Array(11).fill(!1));this.placeIntersectingPair();let E=0,M=0;while(E<6&&M<200){if(this.placeDetachedWall())E++;M++}this.fixClosedBoxes()}fixClosedBoxes(){let E=[];for(let A=0;A<6;A++)E.push(Array(11).fill(!1));let M=-1,F=-1;for(let A=0;A<6&&M<0;A++)for(let _=0;_<11&&F<0;_++)if(!this.wallMatrix[A][_])M=A,F=_;if(M<0)return;let S=[{row:M,col:F}];while(S.length>0){let{row:A,col:_}=S.pop();if(A<0||A>=6||_<0||_>=11)continue;if(E[A][_]||this.wallMatrix[A][_])continue;E[A][_]=!0,S.push({row:A-1,col:_}),S.push({row:A+1,col:_}),S.push({row:A,col:_-1}),S.push({row:A,col:_+1})}for(let A=0;A<6;A++)for(let _=0;_<11;_++)if(!this.wallMatrix[A][_]&&!E[A][_]){this.breakOpenAt(A,_),this.fixClosedBoxes();return}}breakOpenAt(E,M){let F=[{dr:-1,dc:0},{dr:1,dc:0},{dr:0,dc:-1},{dr:0,dc:1}],S=(A,_)=>{return this.intersectionTiles.has(`${A},${_}`)};for(let{dr:A,dc:_}of F){let f=E+A,D=M+_;if(f>=0&&f<6&&D>=0&&D<11){if(this.wallMatrix[f][D]&&!S(f,D)){if(this.getWallSegmentLength(f,D)>2){this.wallMatrix[f][D]=!1;return}}}}for(let{dr:A,dc:_}of F){let f=E+A,D=M+_;if(f>=0&&f<6&&D>=0&&D<11){if(this.wallMatrix[f][D]&&!S(f,D)){let q=this.getWallSegment(f,D);if(q&&this.canSlideWall(q,A,_)){this.slideWall(q,A,_);return}}}}for(let{dr:A,dc:_}of F){let f=E+A,D=M+_;if(f>=0&&f<6&&D>=0&&D<11){if(this.wallMatrix[f][D]&&!S(f,D)){let q=this.getWallSegment(f,D);if(q){for(let G of q)this.wallMatrix[G.row][G.col]=!1;this.placeDetachedWall();return}}}}}getWallSegment(E,M){if(!this.wallMatrix[E][M])return null;let F=[{row:E,col:M}],S=M>0&&this.wallMatrix[E][M-1],A=M<10&&this.wallMatrix[E][M+1],_=E>0&&this.wallMatrix[E-1][M],f=E<5&&this.wallMatrix[E+1][M],D=S||A,q=_||f;if(D&&q)return null;if(D){for(let G=M-1;G>=0&&this.wallMatrix[E][G];G--)F.push({row:E,col:G});for(let G=M+1;G<11&&this.wallMatrix[E][G];G++)F.push({row:E,col:G})}else if(q){for(let G=E-1;G>=0&&this.wallMatrix[G][M];G--)F.push({row:G,col:M});for(let G=E+1;G<6&&this.wallMatrix[G][M];G++)F.push({row:G,col:M})}return F}canSlideWall(E,M,F){for(let S of E){let A=S.row+M,_=S.col+F;if(A<0||A>=6||_<0||_>=11)return!1;let f=[{r:A-1,c:_},{r:A+1,c:_},{r:A,c:_-1},{r:A,c:_+1}];for(let D of f)if(D.r>=0&&D.r<6&&D.c>=0&&D.c<11){if(this.wallMatrix[D.r][D.c]){if(!E.some((G)=>G.row===D.r&&G.col===D.c))return!1}}}return!0}slideWall(E,M,F){for(let S of E)this.wallMatrix[S.row][S.col]=!1;for(let S of E){let A=S.row+M,_=S.col+F;this.wallMatrix[A][_]=!0}}getWallSegmentLength(E,M){if(!this.wallMatrix[E][M])return 0;let F=M>0&&this.wallMatrix[E][M-1]||M<10&&this.wallMatrix[E][M+1],S=E>0&&this.wallMatrix[E-1][M]||E<5&&this.wallMatrix[E+1][M],A=1;if(F&&!S){for(let _=M-1;_>=0&&this.wallMatrix[E][_];_--)A++;for(let _=M+1;_<11&&this.wallMatrix[E][_];_++)A++}else if(S&&!F){for(let _=E-1;_>=0&&this.wallMatrix[_][M];_--)A++;for(let _=E+1;_<6&&this.wallMatrix[_][M];_++)A++}else A=Math.max(A,2);return A}placeIntersectingPair(){this.intersectionTiles.clear();let E=2,M=3,F={left:1,right:1,up:1,down:1},S=["left","right","up","down"],A=S[Math.floor(Math.random()*S.length)];F[A]=2;for(let _=M-F.left;_<=M+F.right;_++)this.wallMatrix[E][_]=!0,this.intersectionTiles.add(`${E},${_}`);for(let _=E-F.up;_<=E+F.down;_++)this.wallMatrix[_][M]=!0,this.intersectionTiles.add(`${_},${M}`)}placeDetachedWall(){let E=Math.random()<0.5,M=2+Math.floor(Math.random()*4),F,S,A=[];if(E){let _=10-M;if(_<1)return!1;F=1+Math.floor(Math.random()*_),S=1+Math.floor(Math.random()*4);for(let f=F;f<F+M;f++)A.push({row:S,col:f})}else{let _=5-M;if(_<1)return!1;S=1+Math.floor(Math.random()*_),F=1+Math.floor(Math.random()*9);for(let f=S;f<S+M;f++)A.push({row:f,col:F})}for(let _ of A)if(this.touchesAnyWall(_.row,_.col))return!1;for(let _ of A)this.wallMatrix[_.row][_.col]=!0;return!0}touchesAnyWall(E,M){if(this.wallMatrix[E][M])return!0;if(E>0&&this.wallMatrix[E-1][M])return!0;if(E<5&&this.wallMatrix[E+1][M])return!0;if(M>0&&this.wallMatrix[E][M-1])return!0;if(M<10&&this.wallMatrix[E][M+1])return!0;return!1}isWall(E,M){if(E<0||E>=6||M<0||M>=11)return!1;return this.wallMatrix[E][M]}getTileIndex(E,M){let F=this.isWall(E-1,M),S=this.isWall(E+1,M),A=this.isWall(E,M-1),_=this.isWall(E,M+1),f=F||S,D=A||_;if(f&&D)return 4;if(f)if(F&&S)return 0;else if(S)return 1;else return 6;if(D)if(A&&_)return 2;else if(_)return 3;else return 5;return 4}renderMapToBuffer(){if(this.mapCanvas=new OffscreenCanvas(1320,720),this.mapCtx=this.mapCanvas.getContext("2d"),this.grassImg){let E=this.grassImg.width,M=this.grassImg.height;for(let F=0;F<720;F+=M)for(let S=0;S<1320;S+=E)this.mapCtx.drawImage(this.grassImg,S,F)}}update(E,M){if(E.fillStyle="#000000",E.fillRect(0,0,E.canvas.width,E.canvas.height),this.grassImg){E.globalAlpha=0.3;let G=this.grassImg.width,B=this.grassImg.height;for(let $=0;$<E.canvas.height;$+=B)for(let J=0;J<E.canvas.width;J+=G)E.drawImage(this.grassImg,J,$);E.globalAlpha=1}if(E.save(),E.translate(this.offsetX,this.offsetY),E.scale(this.scale,this.scale),E.beginPath(),E.rect(0,0,426,720),E.clip(),!this.gameStarted){if(this.grassImg){let G=this.grassImg.width,B=this.grassImg.height;for(let $=0;$<720;$+=B)for(let J=0;J<426;J+=G)E.drawImage(this.grassImg,J,$,G+1,B+1)}if(this.titleImg)E.drawImage(this.titleImg,0,0,426,720);E.restore();return}if(!this.mapCanvas){E.restore();return}let F=performance.now(),S=250;if(F-this.lastAnimTime>=S)this.player.frame=(this.player.frame+1)%2,this.lastAnimTime=F;let A=250;for(let G of this.npcs)if(!G.dead&&F-G.lastAnimTime>=A)G.frame=(G.frame+1)%2,G.lastAnimTime=F;if(!this.gameOver&&!this.levelComplete){let G=this.player.x,B=this.player.y;if(this.keys.has("ArrowLeft"))G-=8;if(this.keys.has("ArrowRight"))G+=8;if(this.keys.has("ArrowUp"))B-=8;if(this.keys.has("ArrowDown"))B+=8;if(this.mouseTarget&&this.isMouseDown){let $=this.mouseTarget.x-(this.player.x+this.player.width/2),J=this.mouseTarget.y-(this.player.y+this.player.height/2),K=Math.sqrt($*$+J*J);if(K>10)G=this.player.x+$/K*8,B=this.player.y+J/K*8}if(!this.collidesWithWall(G,this.player.y))this.player.x=G;if(!this.collidesWithWall(this.player.x,B))this.player.y=B;this.player.x=Math.max(0,Math.min(this.player.x,1320-this.player.width)),this.player.y=Math.max(0,Math.min(this.player.y,720-this.player.height)),this.updateNPCs(performance.now()),this.checkChickCollisions(),this.checkDogCollision()}this.cameraX=this.player.x+this.player.width/2-213,this.cameraY=this.player.y+this.player.height/2-360,this.cameraX=Math.max(0,Math.min(this.cameraX,894)),this.cameraY=Math.max(0,Math.min(this.cameraY,0)),E.clearRect(0,0,426,720),E.drawImage(this.mapCanvas,this.cameraX,this.cameraY,426,720,0,0,426,720),E.globalCompositeOperation="source-over",E.font="bold 24px sans-serif",E.textAlign="left",E.textBaseline="top";let _="Score: ",f=`${this.score}`,D=12+E.measureText(_).width;E.shadowColor="rgba(0, 0, 0, 1)",E.shadowBlur=8,E.shadowOffsetX=0,E.shadowOffsetY=0,E.fillStyle="#ff5555",E.fillText(_,12,40),E.fillStyle="#ffffff",E.fillText(f,D,40),E.font="14px sans-serif",E.fillStyle="#ffffff",E.fillText(`High Score: ${this.highScore}`,12,68),E.shadowColor="transparent",E.shadowBlur=0;let q=[];if(this.bushesImg){for(let G=0;G<6;G++)for(let B=0;B<11;B++)if(this.wallMatrix[G][B]){let $=this.getTileIndex(G,B);q.push({type:"bush",img:this.bushesImg,x:B*120,y:G*120,tileIndex:$})}}if(this.foxImg)q.push({type:"player",img:this.foxImg,x:this.player.x,y:this.player.y});for(let G of this.npcs)if(G.dead)q.push({type:"bone",img:G.img,x:G.x,y:G.y});else q.push({type:"npc",img:G.img,x:G.x,y:G.y,frame:G.frame});q.sort((G,B)=>G.y-B.y);for(let G of q){let B=G.x-this.cameraX,$=G.y-this.cameraY;if(G.type==="bush"&&G.tileIndex!==void 0)E.drawImage(G.img,G.tileIndex*120,0,120,120,B,$,120,120);else if(G.type==="player")E.fillStyle="rgba(0, 0, 0, 0.25)",E.beginPath(),E.ellipse(B+60,$+120-10,22,8,0,0,Math.PI*2),E.fill(),E.drawImage(G.img,this.player.frame*120,0,120,120,B,$,120,120);else if(G.type==="npc"&&G.frame!==void 0)E.fillStyle="rgba(0, 0, 0, 0.25)",E.beginPath(),E.ellipse(B+60,$+120-15,22,8,0,0,Math.PI*2),E.fill(),E.drawImage(G.img,G.frame*120,0,120,120,B,$,120,120);else if(G.type==="bone")E.fillStyle="rgba(0, 0, 0, 0.25)",E.beginPath(),E.ellipse(B+60,$+120-24,55,10,0,0,Math.PI*2),E.fill(),E.drawImage(G.img,B,$,120,120);else E.drawImage(G.img,B,$,120,120)}if(this.gameOver)E.fillStyle="rgba(0, 0, 0, 0.6)",E.fillRect(0,0,426,720),E.fillStyle="#ff5555",E.font="bold 48px sans-serif",E.textAlign="center",E.textBaseline="middle",E.fillText("Game Over",213,330),E.fillStyle="#ffffff",E.font="24px sans-serif",E.fillText("Tap to Retry",213,390);if(this.levelComplete)E.fillStyle="rgba(0, 0, 0, 0.6)",E.fillRect(0,0,426,720),E.fillStyle="#55ff55",E.font="bold 48px sans-serif",E.textAlign="center",E.textBaseline="middle",E.fillText("Level Complete",213,330),E.fillStyle="#ffffff",E.font="24px sans-serif",E.fillText("Tap to Continue",213,390);E.restore()}collidesWithWall(E,M){let F=E+20,S=M+20,A=Math.floor(F/120),_=Math.floor((F+80-1)/120),f=Math.floor(S/120),D=Math.floor((S+80-1)/120);for(let q=f;q<=D;q++)for(let G=A;G<=_;G++)if(this.wallMatrix[q]?.[G]){let B=G*120+20,$=q*120+20;if(F<B+80&&F+80>B&&S<$+80&&S+80>$)return!0}for(let q of this.npcs)if(!q.dead&&q.type!=="chick"&&this.hitboxesOverlap(E,M,q.x,q.y))return!0;return!1}checkChickCollisions(){for(let E of this.npcs)if(E.type==="chick"&&!E.dead){if(this.hitboxesOverlap(this.player.x,this.player.y,E.x,E.y)){if(E.dead=!0,this.score++,this.score>this.highScore)this.highScore=this.score,this.saveHighScore();if(this.chickBonesImg)E.img=this.chickBonesImg;if(this.cluckSound)this.cluckSound.currentTime=0,this.cluckSound.play();if(this.npcs.filter((F)=>F.type==="chick"&&!F.dead).length===0)this.levelComplete=!0}}}checkDogCollision(){for(let E of this.npcs)if(E.type==="dog"&&!E.dead){if(this.hitboxesOverlap(this.player.x,this.player.y,E.x,E.y)){if(this.gameOver=!0,this.introSound)this.introSound.currentTime=0,this.introSound.play();return}}}updateNPCs(E){let M=this.getSpeedMultiplier();for(let F of this.npcs){if(F.dead)continue;let S=this.hasLineOfSight(F.x,F.y,this.player.x,this.player.y),A=this.player.x-F.x,_=this.player.y-F.y,f=Math.sqrt(A*A+_*_);if(F.type==="chick")if(S)this.moveNpcAway(F,this.player.x,this.player.y,5*M);else this.wanderNpc(F,E,2*M);else if(F.type==="dog")if(S&&f<300){if(this.moveNpcToward(F,this.player.x,this.player.y,5*M),this.barkSound&&E-this.lastBarkTime>=4000)this.barkSound.currentTime=0,this.barkSound.play(),this.lastBarkTime=E}else this.wanderNpc(F,E,3*M);if(F.x=Math.max(0,Math.min(F.x,1320-F.width)),F.y=Math.max(0,Math.min(F.y,720-F.height)),Math.abs(F.x-F.prevX)+Math.abs(F.y-F.prevY)<0.5)F.stuckTime++;else F.stuckTime=0;F.prevX=F.x,F.prevY=F.y}}wanderNpc(E,M,F){let S=E.wanderTarget.x-E.x,A=E.wanderTarget.y-E.y;if(Math.sqrt(S*S+A*A)<20||M>E.nextWanderTime||E.stuckTime>15)this.pickRandomWanderTarget(E),E.nextWanderTime=M+1000+Math.random()*1000,E.stuckTime=0;this.moveNpcToward(E,E.wanderTarget.x,E.wanderTarget.y,F)}pickRandomWanderTarget(E){for(let M=0;M<20;M++){let F=Math.floor(Math.random()*11),S=Math.floor(Math.random()*6);if(S>=0&&S<6&&F>=0&&F<11){if(!this.wallMatrix[S][F]){E.wanderTarget.x=F*120,E.wanderTarget.y=S*120;return}}}}moveNpcToward(E,M,F,S){let A=M-E.x,_=F-E.y,f=Math.sqrt(A*A+_*_);if(f<1)return;let D=A/f*S,q=_/f*S,G=E.x+D,B=E.y+q;if(!this.npcCollidesWithWall(E,G,E.y))E.x=G;if(!this.npcCollidesWithWall(E,E.x,B))E.y=B}moveNpcAway(E,M,F,S){let A=E.x-M,_=E.y-F,f=Math.sqrt(A*A+_*_);if(f<1)return;let D=A/f*S,q=_/f*S,G=20,B=!1;if(E.x<=G&&D<0)D=0,B=!0;if(E.x>=1320-E.width-G&&D>0)D=0,B=!0;if(E.y<=G&&q<0)q=0,B=!0;if(E.y>=720-E.height-G&&q>0)q=0,B=!0;if(B||E.stuckTime>5){let K=S*0.8;D+=(Math.random()-0.5)*K*2,q+=(Math.random()-0.5)*K*2}let $=E.x+D,J=E.y+q;if(!this.npcCollidesWithWall(E,$,E.y))E.x=$;if(!this.npcCollidesWithWall(E,E.x,J))E.y=J}npcCollidesWithWall(E,M,F){let S=M+20,A=F+20,_=Math.floor(S/120),f=Math.floor((S+80-1)/120),D=Math.floor(A/120),q=Math.floor((A+80-1)/120);for(let G=D;G<=q;G++)for(let B=_;B<=f;B++)if(this.wallMatrix[G]?.[B]){let $=B*120+20,J=G*120+20;if(S<$+80&&S+80>$&&A<J+80&&A+80>J)return!0}return!1}hasLineOfSight(E,M,F,S){let A=E+60,_=M+60,f=F+60,D=S+60,q=f-A,G=D-_,B=Math.sqrt(q*q+G*G),$=Math.max(1,Math.floor(B/20));for(let J=0;J<=$;J++){let K=J/$,j=A+q*K,I=_+G*K,O=Math.floor(j/120),T=Math.floor(I/120);if(this.wallMatrix[T]?.[O])return!1}return!0}}var U=new Q("game");await U.setScene(new Z);U.start();
